# 在线加密文件解密SAAS平台 - 数据库设计文档

## 1. 文档说明

### 1.1 文档目的
本文档描述数据库表结构、字段定义、关系设计、索引策略等内容。

### 1.2 数据库选型
- **数据库**: PostgreSQL 15+
- **字符集**: UTF-8
- **时区**: UTC

### 1.3 命名规范
- 表名：小写蛇形命名法 `user_profiles`
- 字段名：小写蛇形命名法 `created_at`
- 主键：`id`
-外键：`{表名}_id`
- 索引：`idx_{表名}_{字段名}`
- 唯一索引：`uk_{表名}_{字段名}`

## 2. 数据库ER图

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│   users         │         │   user_profiles │         │  memberships    │
├─────────────────┤         ├─────────────────┤         ├─────────────────┤
│ id (PK)         │──┐   ┌──│ user_id (PK)    │         │ id (PK)         │
│ email (UK)      │  │   │  │ avatar          │         │ user_id (FK)    │
│ password_hash   │  └──┘  │ phone           │         │ plan            │
│ username        │         │ preferences     │         │ expire_at       │
│ is_active       │         └─────────────────┘         │ auto_renew      │
│ created_at      │                                      └─────────────────┘
│ updated_at      │
└─────────────────┘
         │
         │
         ▼
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│   files         │         │    tasks        │         │  task_logs      │
├─────────────────┤         ├─────────────────┤         ├─────────────────┤
│ id (PK)         │──┐   ┌──│ id (PK)         │◄────┐   │ id (PK)         │
│ user_id (FK)    │  │   │  │ user_id (FK)    │     │   │ task_id (FK)    │
│ file_name       │  └──┘  │ file_id (FK)    │     └───│ level            │
│ file_size       │         │ crack_type      │         │ message          │
│ file_type       │         │ crack_config    │         │ created_at      │
│ storage_key     │         │ status          │         └─────────────────┘
│ md5_hash        │         │ progress        │
│ status          │         │ result          │
│ created_at      │         │ created_at      │
└─────────────────┘         └─────────────────┘
         │                            │
         │                            │
         ▼                            ▼
┌─────────────────┐         ┌─────────────────┐
│   orders        │         │  notifications  │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ user_id (FK)    │         │ user_id (FK)    │
│ task_id (FK)    │         │ type            │
│ order_no (UK)   │         │ title           │
│ amount          │         │ content         │
│ discount        │         │ is_read         │
│ final_amount    │         │ created_at      │
│ status          │         └─────────────────┘
│ payment_method  │
│ paid_at         │
│ created_at      │
└─────────────────┘
         │
         ▼
┌─────────────────┐         ┌─────────────────┐
│   refunds       │         │   api_keys      │
├─────────────────┤         ├─────────────────┤
│ id (PK)         │         │ id (PK)         │
│ order_id (FK)   │         │ user_id (FK)    │
│ amount          │         │ name            │
│ status          │         │ key_hash        │
│ reason          │         │ scopes          │
│ created_at      │         │ expires_at      │
│ completed_at    │         │ last_used       │
└─────────────────┘         │ created_at      │
                            └─────────────────┘
```

## 3. 表结构设计

### 3.1 用户表 (users)

存储用户基本信息和认证信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| email | VARCHAR | 255 | NO | - | 邮箱（唯一） |
| password_hash | VARCHAR | 255 | NO | - | 密码哈希（bcrypt） |
| username | VARCHAR | 50 | YES | NULL | 用户名 |
| is_active | BOOLEAN | - | NO | true | 是否激活 |
| is_verified | BOOLEAN | - | NO | false | 邮箱是否验证 |
| is_admin | BOOLEAN | - | NO | false | 是否管理员 |
| last_login_at | TIMESTAMP | - | YES | NULL | 最后登录时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX uk_users_email ON users(email);

-- 普通索引
CREATE INDEX idx_users_is_active ON users(is_active);
CREATE INDEX idx_users_created_at ON users(created_at);
```

**约束**:
```sql
-- 邮箱格式约束
CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')

-- 用户名长度约束
CHECK (username IS NULL OR LENGTH(username) >= 2)
```

### 3.2 用户资料表 (user_profiles)

存储用户扩展信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| user_id | UUID | - | NO | - | 用户ID（主键、外键） |
| avatar | VARCHAR | 500 | YES | NULL | 头像URL |
| phone | VARCHAR | 20 | YES | NULL | 手机号 |
| country | VARCHAR | 50 | YES | NULL | 国家 |
| language | VARCHAR | 10 | NO | 'zh-CN' | 语言偏好 |
| timezone | VARCHAR | 50 | NO | 'Asia/Shanghai' | 时区 |
| preferences | JSONB | - | NO | '{}' | 用户偏好设置 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (user_id)

-- 外键索引
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

-- 外键约束
ALTER TABLE user_profiles
ADD CONSTRAINT fk_user_profiles_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

**preferences JSONB结构示例**:
```json
{
  "notification": {
    "email": {
      "task_created": true,
      "task_completed": true,
      "task_failed": true
    },
    "sms": {
      "task_completed": false
    },
    "webhook": {
      "enabled": false,
      "url": ""
    }
  },
  "ui": {
    "theme": "light",
    "sidebar_collapsed": false
  }
}
```

### 3.3 会员表 (memberships)

存储用户会员信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| plan | VARCHAR | 20 | NO | - | 会员计划：free/basic/premium/enterprise |
| expire_at | TIMESTAMP | - | YES | NULL | 到期时间 |
| auto_renew | BOOLEAN | - | NO | false | 自动续费 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引（一个用户同时只能有一个有效会员）
CREATE UNIQUE INDEX uk_memberships_user_id ON memberships(user_id)
WHERE expire_at > CURRENT_TIMESTAMP;

-- 普通索引
CREATE INDEX idx_memberships_user_id ON memberships(user_id);
CREATE INDEX idx_memberships_expire_at ON memberships(expire_at);

-- 外键约束
ALTER TABLE memberships
ADD CONSTRAINT fk_memberships_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

### 3.4 文件表 (files)

存储上传文件信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| file_name | VARCHAR | 255 | NO | - | 原始文件名 |
| file_size | BIGINT | - | NO | - | 文件大小（字节） |
| file_type | VARCHAR | 20 | NO | - | 文件类型：zip/rar/7z/pdf/doc/xls等 |
| mime_type | VARCHAR | 100 | NO | - | MIME类型 |
| storage_key | VARCHAR | 500 | NO | - | 存储key（对象存储路径） |
| storage_provider | VARCHAR | 20 | NO | 'minio' | 存储提供商：minio/oss/s3 |
| md5_hash | VARCHAR | 32 | YES | NULL | MD5哈希 |
| sha256_hash | VARCHAR | 64 | YES | NULL | SHA256哈希 |
| is_encrypted | BOOLEAN | - | NO | false | 是否加密文件 |
| encryption_info | JSONB | - | YES | NULL | 加密信息 |
| scan_status | VARCHAR | 20 | NO | 'pending' | 病毒扫描状态 |
| scan_result | TEXT | - | YES | NULL | 扫描结果 |
| expires_at | TIMESTAMP | - | YES | NULL | 过期时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
CREATE INDEX idx_files_user_id ON files(user_id);
CREATE INDEX idx_files_storage_key ON files(storage_key);
CREATE INDEX idx_files_created_at ON files(created_at);
CREATE INDEX idx_files_expires_at ON files(expires_at);

-- 外键约束
ALTER TABLE files
ADD CONSTRAINT fk_files_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

**encryption_info JSONB结构示例**:
```json
{
  "algorithm": "AES-256",
  "key_size": 256,
  "has_password": true,
  "compression": true
}
```

### 3.5 任务表 (tasks)

存储破解任务信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| file_id | UUID | - | NO | - | 文件ID（外键） |
| task_name | VARCHAR | 255 | NO | - | 任务名称 |
| crack_type | VARCHAR | 20 | NO | - | 破解类型：simple/normal/advanced |
| crack_config | JSONB | - | NO | '{}' | 破解配置 |
| status | VARCHAR | 20 | NO | 'pending' | 任务状态 |
| priority | INTEGER | - | NO | 5 | 优先级（1-10，数字越大优先级越高） |
| progress | INTEGER | - | NO | 0 | 进度（0-100） |
| result | JSONB | - | YES | NULL | 破解结果 |
| error_message | TEXT | - | YES | NULL | 错误信息 |
| worker_id | VARCHAR | 100 | YES | NULL | 执行的Worker ID |
| estimated_time | INTEGER | - | YES | NULL | 预计耗时（秒） |
| started_at | TIMESTAMP | - | YES | NULL | 开始时间 |
| completed_at | TIMESTAMP | - | YES | NULL | 完成时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_file_id ON tasks(file_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_crack_type ON tasks(crack_type);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);
CREATE INDEX idx_tasks_priority_status ON tasks(priority, status);

-- 外键约束
ALTER TABLE tasks
ADD CONSTRAINT fk_tasks_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;

ALTER TABLE tasks
ADD CONSTRAINT fk_tasks_file
FOREIGN KEY (file_id) REFERENCES files(id)
ON DELETE CASCADE;
```

**crack_config JSONB结构示例**:
```json
{
  "password_length": 6,
  "password_type": "numeric",
  "charset": "0123456789",
  "password_hint": "生日是1990年",
  "enable_mask": false,
  "mask_pattern": null
}
```

**result JSONB结构示例**:
```json
{
  "password": "123456",
  "attempts": 123456,
  "duration": 120,
  "method": "dictionary_attack"
}
```

**status枚举值**:
- `pending`: 等待中
- `queued`: 队列中
- `analyzing`: 分析中
- `processing`: 处理中
- `completed`: 已完成
- `failed`: 失败
- `cancelled`: 已取消

### 3.6 任务日志表 (task_logs)

存储任务执行日志。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| task_id | UUID | - | NO | - | 任务ID（外键） |
| level | VARCHAR | 20 | NO | - | 日志级别：DEBUG/INFO/WARNING/ERROR |
| message | TEXT | - | NO | - | 日志消息 |
| extra | JSONB | - | YES | NULL | 额外信息 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
CREATE INDEX idx_task_logs_task_id ON task_logs(task_id);
CREATE INDEX idx_task_logs_level ON task_logs(level);
CREATE INDEX idx_task_logs_created_at ON task_logs(created_at);

-- 外键约束
ALTER TABLE task_logs
ADD CONSTRAINT fk_task_logs_task
FOREIGN KEY (task_id) REFERENCES tasks(id)
ON DELETE CASCADE;
```

**分区策略**（按月分区）:
```sql
-- 按月分区，保留6个月
CREATE TABLE task_logs (
    ...
) PARTITION BY RANGE (created_at);

-- 创建分区
CREATE TABLE task_logs_2024_01 PARTITION OF task_logs
FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

### 3.7 订单表 (orders)

存储支付订单信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| task_id | UUID | - | YES | NULL | 关联任务ID（外键） |
| order_no | VARCHAR | 32 | NO | - | 订单号（唯一） |
| amount | DECIMAL | 10,2 | NO | - | 订单金额 |
| discount | DECIMAL | 10,2 | NO | 0 | 折扣金额 |
| final_amount | DECIMAL | 10,2 | NO | - | 实付金额 |
| currency | VARCHAR | 10 | NO | 'CNY' | 货币 |
| coupon_id | UUID | - | YES | NULL | 优惠券ID |
| status | VARCHAR | 20 | NO | 'pending' | 订单状态 |
| payment_method | VARCHAR | 20 | YES | NULL | 支付方式 |
| payment_provider | VARCHAR | 20 | YES | NULL | 支付提供商 |
| transaction_id | VARCHAR | 100 | YES | NULL | 第三方交易ID |
| paid_at | TIMESTAMP | - | YES | NULL | 支付时间 |
| expires_at | TIMESTAMP | - | YES | NULL | 过期时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX uk_orders_order_no ON orders(order_no);

-- 普通索引
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_task_id ON orders(task_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);

-- 外键约束
ALTER TABLE orders
ADD CONSTRAINT fk_orders_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;

ALTER TABLE orders
ADD CONSTRAINT fk_orders_task
FOREIGN KEY (task_id) REFERENCES tasks(id)
ON DELETE SET NULL;
```

**status枚举值**:
- `pending`: 待支付
- `processing`: 支付中
- `paid`: 已支付
- `failed`: 支付失败
- `cancelled`: 已取消
- `refunded`: 已退款
- `expired`: 已过期

### 3.8 退款表 (refunds)

存储退款信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| order_id | UUID | - | NO | - | 订单ID（外键） |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| refund_no | VARCHAR | 32 | NO | - | 退款单号（唯一） |
| amount | DECIMAL | 10,2 | NO | - | 退款金额 |
| status | VARCHAR | 20 | NO | 'pending' | 退款状态 |
| reason | TEXT | - | YES | NULL | 退款原因 |
| provider_refund_id | VARCHAR | 100 | YES | NULL | 第三方退款ID |
| processed_at | TIMESTAMP | - | YES | NULL | 处理时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX uk_refunds_refund_no ON refunds(refund_no);

-- 普通索引
CREATE INDEX idx_refunds_order_id ON refunds(order_id);
CREATE INDEX idx_refunds_user_id ON refunds(user_id);
CREATE INDEX idx_refunds_status ON refunds(status);

-- 外键约束
ALTER TABLE refunds
ADD CONSTRAINT fk_refunds_order
FOREIGN KEY (order_id) REFERENCES orders(id)
ON DELETE CASCADE;

ALTER TABLE refunds
ADD CONSTRAINT fk_refunds_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

### 3.9 通知表 (notifications)

存储用户通知。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| type | VARCHAR | 50 | NO | - | 通知类型 |
| title | VARCHAR | 255 | NO | - | 通知标题 |
| content | TEXT | - | YES | NULL | 通知内容 |
| data | JSONB | - | YES | NULL | 关联数据 |
| is_read | BOOLEAN | - | NO | false | 是否已读 |
| read_at | TIMESTAMP | - | YES | NULL | 阅读时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 普通索引
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_type ON notifications(type);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at);

-- 复合索引
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = false;

-- 外键约束
ALTER TABLE notifications
ADD CONSTRAINT fk_notifications_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

**type枚举值**:
- `task_created`: 任务创建
- `task_started`: 任务开始
- `task_completed`: 任务完成
- `task_failed`: 任务失败
- `payment_success`: 支付成功
- `payment_failed`: 支付失败
- `refund_completed`: 退款完成

### 3.10 API密钥表 (api_keys)

存储企业用户的API密钥。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| name | VARCHAR | 100 | NO | - | 密钥名称 |
| key_hash | VARCHAR | 255 | NO | - | 密钥哈希（SHA256） |
| key_prefix | VARCHAR | 10 | NO | - | 密钥前缀（用于显示） |
| scopes | TEXT[] | - | NO | '{}' | 权限范围 |
| rate_limit | INTEGER | - | YES | NULL | 速率限制（次/分钟） |
| ip_whitelist | TEXT[] | - | YES | NULL | IP白名单 |
| is_active | BOOLEAN | - | NO | true | 是否激活 |
| last_used_at | TIMESTAMP | - | YES | NULL | 最后使用时间 |
| expires_at | TIMESTAMP | - | YES | NULL | 过期时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
CREATE UNIQUE INDEX uk_api_keys_key_hash ON api_keys(key_hash);

-- 普通索引
CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_key_prefix ON api_keys(key_prefix);

-- 外键约束
ALTER TABLE api_keys
ADD CONSTRAINT fk_api_keys_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;
```

**scopes权限范围**:
- `tasks:read`: 读取任务
- `tasks:create`: 创建任务
- `tasks:delete`: 删除任务
- `files:read`: 读取文件
- `files:upload`: 上传文件
- `files:delete`: 删除文件

### 3.11 优惠券表 (coupons)

存储优惠券信息。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| code | VARCHAR | 20 | NO | - | 优惠码（唯一） |
| name | VARCHAR | 100 | NO | - | 优惠券名称 |
| description | TEXT | - | YES | NULL | 描述 |
| discount_type | VARCHAR | 20 | NO | - | 折扣类型：percent/fixed |
| discount_value | DECIMAL | 10,2 | NO | - | 折扣值 |
| min_amount | DECIMAL | 10,2 | YES | NULL | 最低消费金额 |
| max_discount | DECIMAL | 10,2 | YES | NULL | 最大折扣金额 |
| usage_limit | INTEGER | - | YES | NULL | 使用次数限制 |
| used_count | INTEGER | - | NO | 0 | 已使用次数 |
| valid_from | TIMESTAMP | - | NO | - | 有效期开始 |
| valid_until | TIMESTAMP | - | NO | - | 有效期结束 |
| is_active | BOOLEAN | - | NO | true | 是否激活 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id);

-- 唯一索引
CREATE UNIQUE INDEX uk_coupons_code ON coupons(code);

-- 普通索引
CREATE INDEX idx_coupons_is_active ON coupons(is_active);
CREATE INDEX idx_coupons_valid_period ON coupons(valid_from, valid_until);
```

### 3.12 用户优惠券表 (user_coupons)

存储用户领取的优惠券。

| 字段名 | 类型 | 长度 | 可空 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | UUID | - | NO | - | 主键 |
| user_id | UUID | - | NO | - | 用户ID（外键） |
| coupon_id | UUID | - | NO | - | 优惠券ID（外键） |
| status | VARCHAR | 20 | NO | 'available' | 状态 |
| used_at | TIMESTAMP | - | YES | NULL | 使用时间 |
| order_id | UUID | - | YES | NULL | 使用的订单ID |
| expires_at | TIMESTAMP | - | NO | - | 过期时间 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引**:
```sql
-- 主键索引
PRIMARY KEY (id);

-- 普通索引
CREATE INDEX idx_user_coupons_user_id ON user_coupons(user_id);
CREATE INDEX idx_user_coupons_status ON user_coupons(status);
CREATE INDEX idx_user_coupons_expires_at ON user_coupons(expires_at);

-- 外键约束
ALTER TABLE user_coupons
ADD CONSTRAINT fk_user_coupons_user
FOREIGN KEY (user_id) REFERENCES users(id)
ON DELETE CASCADE;

ALTER TABLE user_coupons
ADD CONSTRAINT fk_user_coupons_coupon
FOREIGN KEY (coupon_id) REFERENCES coupons(id)
ON DELETE CASCADE;
```

**status枚举值**:
- `available`: 可用
- `used`: 已使用
- `expired`: 已过期

## 4. 数据字典

### 4.1 任务状态字典

| 状态值 | 中文名称 | 说明 |
|--------|---------|------|
| pending | 等待中 | 任务已创建，等待处理 |
| queued | 队列中 | 任务已加入处理队列 |
| analyzing | 分析中 | 正在分析文件 |
| processing | 处理中 | 正在破解密码 |
| completed | 已完成 | 破解成功 |
| failed | 失败 | 破解失败 |
| cancelled | 已取消 | 用户取消 |

### 4.2 会员等级字典

| 等级 | 名称 | 并发任务数 | 日任务数 | 折扣 |
|------|------|-----------|---------|------|
| free | 免费用户 | 1 | 3 | 无 |
| basic | 基础会员 | 2 | 5 | 95折 |
| premium | 高级会员 | 3 | 10 | 9折 |
| enterprise | 企业会员 | 10 | 100 | 8折 |

### 4.3 破解类型字典

| 类型 | 名称 | 支持密码复杂度 | 价格 | 预计时间 |
|------|------|---------------|------|---------|
| simple | 简单密码 | 6位纯数字 | 免费 | 5分钟 |
| normal | 常规任务 | 字母+数字+符号，最长12位 | ¥29-199 | 最长7天 |
| advanced | 专业破解 | 复杂密码，GPU加速 | ¥200起 | 按评估 |

### 4.4 文件类型字典

| 类型 | 扩展名 | MIME类型 |
|------|--------|----------|
| zip | .zip | application/zip |
| rar | .rar | application/x-rar-compressed |
| 7z | .7z | application/x-7z-compressed |
| pdf | .pdf | application/pdf |
| doc | .doc | application/msword |
| docx | .docx | application/vnd.openxmlformats-officedocument.wordprocessingml.document |
| xls | .xls | application/vnd.ms-excel |
| xlsx | .xlsx | application/vnd.openxmlformats-officedocument.spreadsheetml.sheet |

## 5. 数据库初始化

### 5.1 初始化脚本

```sql
-- 创建数据库
CREATE DATABASE filepassword
    WITH
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8'
    TEMPLATE = template0
    CONNECTION LIMIT = -1;

-- 连接到数据库
\c filepassword;

-- 启用UUID扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "pg_trgm";  -- 模糊搜索
CREATE EXTENSION IF NOT EXISTS "btree_gin"; -- 复合索引
```

### 5.2 创建管理员用户

```sql
-- 插入管理员用户
INSERT INTO users (id, email, password_hash, username, is_active, is_admin, is_verified)
VALUES (
    '01234567-0123-0123-0123-012345678901',
    'admin@example.com',
    '$2b$12$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx', -- bcrypt hash
    'Admin',
    true,
    true,
    true
);

-- 创建管理员会员
INSERT INTO memberships (id, user_id, plan, expire_at)
VALUES (
    gen_random_uuid(),
    '01234567-0123-0123-0123-012345678901',
    'enterprise',
    '2099-12-31 23:59:59'
);
```

## 6. 数据库维护

### 6.1 定期清理任务

使用Celery Beat创建定期任务：

```python
# 清理过期文件（每天执行）
@celery_app.task
def cleanup_expired_files():
    """清理过期的上传文件"""
    expired_files = File.objects.filter(
        expires_at__lt=timezone.now(),
        status='uploaded'
    )
    for file in expired_files:
        # 删除对象存储中的文件
        storage.delete(file.storage_key)
        # 标记为已删除
        file.status = 'deleted'
        file.save()

# 清理旧日志（每周执行）
@celery_app.task
def cleanup_old_logs():
    """清理6个月前的日志"""
    six_months_ago = timezone.now() - timedelta(days=180)
    TaskLog.objects.filter(created_at__lt=six_months_ago).delete()

# 清理匿名用户的旧任务（每天执行）
@celery_app.task
def cleanup_old_anonymous_tasks():
    """清理30天前的匿名任务"""
    thirty_days_ago = timezone.now() - timedelta(days=30)
    Task.objects.filter(
        user__isnull=True,
        created_at__lt=thirty_days_ago,
        status__in=['completed', 'failed', 'cancelled']
    ).delete()
```

### 6.2 数据库备份策略

```bash
# 全量备份（每天凌晨2点）
0 2 * * * pg_dump -U postgres filepassword | gzip > /backup/filepassword_$(date +\%Y\%m\%d).sql.gz

# 增量备份（WAL归档）
# postgresql.conf
archive_mode = on
archive_command = 'cp %p /archive/wal/%f'
```

### 6.3 索引优化

```sql
-- 分析表统计信息
ANALYZE users;
ANALYZE tasks;
ANALYZE files;

-- 重建索引
REINDEX TABLE CONCURRENTLY users;
REINDEX TABLE CONCURRENTLY tasks;

-- 清理死元组
VACUUM ANALYZE users;
VACUUM ANALYZE tasks;
```

## 7. 性能优化

### 7.1 慢查询优化

```sql
-- 启用慢查询日志
ALTER DATABASE filepassword SET log_min_duration_statement = 1000; -- 1秒

-- 分析慢查询
EXPLAIN ANALYZE
SELECT * FROM tasks
WHERE user_id = 'xxx' AND status = 'processing'
ORDER BY created_at DESC
LIMIT 20;
```

### 7.2 连接池配置

使用 SQLAlchemy 连接池：

```python
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=20,          # 连接池大小
    max_overflow=10,       # 最大溢出连接数
    pool_timeout=30,       # 获取连接超时时间
    pool_recycle=3600,     # 连接回收时间
    pool_pre_ping=True     # 连接检查
)
```

### 7.3 读写分离

主从复制配置：

```python
# 主库（写）
engine_master = create_engine(MASTER_DB_URL)

# 从库（读）
engine_slave = create_engine(SLAVE_DB_URL)

# 路由
class RoutingSession(Session):
    def get_bind(self, mapper=None, clause=None):
        if clause and getattr(clause, 'is_select', False):
            return engine_slave
        return engine_master
```

## 8. 安全考虑

### 8.1 敏感字段加密

```sql
-- 使用 pgcrypto 扩展加密敏感数据
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 加密函数
SELECT pgp_sym_encrypt('sensitive_data', 'encryption_key');

-- 解密函数
SELECT pgp_sym_decrypt(column_name::bytea, 'encryption_key') FROM table_name;
```

### 8.2 审计日志

```sql
-- 创建审计日志表
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    table_name VARCHAR(50) NOT NULL,
    record_id UUID NOT NULL,
    action VARCHAR(20) NOT NULL, -- INSERT/UPDATE/DELETE
    old_data JSONB,
    new_data JSONB,
    user_id UUID,
    ip_address INET,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建触发器函数
CREATE OR REPLACE FUNCTION audit_trigger_func()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO audit_logs (table_name, record_id, action, new_data, user_id)
        VALUES (TG_TABLE_NAME, NEW.id, 'INSERT', row_to_json(NEW), current_setting('app.user_id')::UUID);
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO audit_logs (table_name, record_id, action, old_data, new_data, user_id)
        VALUES (TG_TABLE_NAME, NEW.id, 'UPDATE', row_to_json(OLD), row_to_json(NEW), current_setting('app.user_id')::UUID);
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO audit_logs (table_name, record_id, action, old_data, user_id)
        VALUES (TG_TABLE_NAME, OLD.id, 'DELETE', row_to_json(OLD), current_setting('app.user_id')::UUID);
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

---

**文档版本：1.0**
**创建日期：2024-12-24**
**文档作者：数据库架构师**
